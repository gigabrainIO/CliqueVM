<!DOCTYPE html>
<head>
  <title>CliqueVM</title>

  <meta charset="utf-8">
  <meta content="width=device-width, height=device-height, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no" name="viewport">

  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="twitter:title" content="CliqueVM">
  <meta name="twitter:description" content="CliqueVM is a framework for building computational models, both classical and quantum mechanical, and tracing their multithreaded evolution as 2D/3D graphs.">
  <meta name="twitter:image" content="https://met4citizen.github.io/CliqueVM/screenshot.jpg">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
  <style>
  html{ width:100%; height:100%; font-size: 1vw; font-family: Verdana, Geneva, sans-serif; }
  body{ width: 100%; height: 100%; margin: 0; padding: 0; background-color: white; color: black; line-height:1vw; overflow: hidden; text-align: left; touch-action: manipulation; }
  h1{font-family: "Courier",monospace; font-size:14px; line-height: 14px; color:#404040; font-weight:bold;}
  .katex { font-size: 1em; }

  ::-webkit-scrollbar { width: 10px; height: 10px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background-color: rgba(119, 136, 153, 0.5); border: transparent; }

  #outer{ display: flex; position: absolute; top: 5.5vw; line-height: 1vw; left:0; right:0; bottom:0; margin:0; padding:0; }
  #graph{ flex: 1; position: relative; margin: 0; padding:0; border-top: 1px solid lightgray; }
  #graph-dot{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; margin: 0; padding:0; overflow:scroll; vertical-align:top; text-align: center; scrollbar-color: rgba(155, 155, 155, 0.5) transparent; scrollbar-width: thin; }
  #graph-dot > svg { margin: 50px 50px 120px 50px; }
  #graph-force{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; margin: 0; padding:0; overflow: hidden; }
  #legend { position: absolute; z-index: 3; opacity: 0.8; bottom:1.5vw; right: 0; margin: 0 15px 0 0; padding: 0; color: slategray; cursor: default; pointer-events: none; font-family: Verdana, Geneva, sans-serif; vertical-align: middle; text-align: left; font-size:1.2vw; line-height: 1.5vw; }
  .legend { display:block; clear:both; width: 100%; height:100%;}
  .legend svg { display: inline-block; margin: 0 5px; padding: 0; height: 1.2vw; }
  #resizer{ flex: 0 0 4px; background-color: white; border-left: 1px solid lightgray; border-right: 1px solid lightgray; margin:0; padding:0; display: none; }
  #resizer:hover{cursor: ew-resize;}
  #panel { flex: 1; display: flex; margin: 0; padding:1vw 0; vertical-align:top; text-align: center; overflow:scroll; display:none; border-top: 1px solid lightgray; border-right: 1px solid lightgray;}
  #text { margin:0; padding: 0; flex: 1; resize: none; font-family: "Courier",monospace; font-size:14px; line-height: 14px; color:#404040; background-color: white; text-align: left; }
  details { position: relative; margin:0; padding:0; }
  details summary { color: slategray; padding: 3px 10px; font-weight: bold; margin: 0; cursor: pointer; vertical-align: middle; }
  details p { display: block; margin: 0 0 0 30px; padding: 5px 0;  white-space: pre-line; overflow-wrap: break-word; }
  .code { resize: none; min-height: 20px; margin:5px 5px 5px 15px; padding: 0px; border: 1px solid lightgrey; overflow: hidden !important; font-size:13px; opacity: 1; }
  .js { margin:5px 0 5px 15px; padding: 4px; white-space: nowrap; opacity: 0.7; }
  .js-key { color: purple; }
  .js-type { color: steelblue; font-weight: bold; }
  .js-param { font-weight: bold; }
  .js-test { display: inline-block; position: absolute; font-size: 10px; padding: 0 4px; margin-left: 10px; color: white; border-radius: 2px; opacity: 0.7; }
  .js-debug { color: darkred; font-weight: bold; white-space: wrap;}


  #toolbar { display: flex; position: absolute; top:1.6vw; left: 0; right: 0; margin: 0 0.7vw 0 0.7vw; padding: 0.3vw; z-index: 3; opacity: 0.6; font-size: 1vw; color: black; text-align: middle; line-height: 3vw; cursor: default; pointer-events: none;}
  #toolbar-panel { flex: 0 0 3vw; display: none; flex-direction: column; margin: 2vw 0.7vw -0.7vw 0.7vw; padding: 0.3vw; z-index: 3; opacity: 0.6; font-size: 1vw; color: black; text-align: middle; line-height: 3vw; cursor: default; pointer-events: none;}
  #title, #title-model { flex: 1; align-items: center; justify-content: center; pointer-events: none; }
  #title div { text-align: center; color: slategray; margin-top: -0.5vw; }
  .title1 { display: block; font-size: 1.5vw; line-height: 1.7vw; font-weight: 600; color: black; transform: scaleX(0.8); }
  .title2 { display: block; font-size: 1.2vw; line-height: 1.4vw; font-weight: 500; }
  .unit { flex: 0 0 3vw; position: relative; margin:0 1px 2.4vw 0; padding: 0; width: 3vw; height: 3vw; border: 0; vertical-align:middle; text-align: center; }
  .unit-action { border-radius: 0.5vw; font-size: 1.2vw; font-weight: 600; cursor: pointer; pointer-events: auto; }
  .unit-text { font-size: 1.2vw; font-weight: 600; pointer-events: none; }
  .unit-zero { flex: 0 0 0; margin: 0; }
  .unit svg { margin: 0; padding: 0; width: 3vw; height: 3vw; }
  .unit-action:active, .selected { background-color: black; color: white; }
  .subtitle { position: absolute; display:block; font-size: 1.2vw; font-weight: 500; vertical-align:middle; text-align: center; margin-left: 50%; height: 3vw; color: slategray; transform: translate(-50%,-2.4vw) scaleX(0.7); white-space: nowrap;}
  .unit-force { flex: 0 0 4.5vw; line-height: 3vw; }
  input[type="range"] { width: 100%; height: 100%; margin: 0.2vw 0 0 0; -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; pointer-events: auto; }
  input[type="range"]::-webkit-slider-runnable-track { background: slategray; height: 0.4vw; }
  input[type="range"]::-moz-range-track { background: slategray; height: 0.4vw; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -0.6vw; background: black; height: 1.6vw; width: 0.7vw; }
  input[type="range"]::-moz-range-thumb { border: none; border-radius: 0; background-color: black; height: 1.6vw; width: 0.7vw; }
  input[type="range"]:focus { outline: none; }
  input[type="range"]:focus::-webkit-slider-thumb { border: 1px solid black; outline: 2px solid black; outline-offset: 1px; }
  input[type="range"]:focus::-moz-range-thumb { border: 1px solid black; outline: 2px solid black; outline-offset: 1px; }

  #export-box { position: absolute; bottom: 12.6vw; right: 5vw; width: 30vw; height: 3.5vw; z-index: 5; padding: 0.5vw; text-align: left; background: white; border: 1px solid black; }
  #import-box { position: absolute; bottom: 7.2vw; right: 5vw; width: 30vw; height: 3.5vw; z-index: 5; padding: 0.5vw; text-align: left; background: white; border: 1px solid black; }
  #export-box span, #import-box span { display:inline-block; font-size: 1.2vw; font-weight: 600; color: slategray; transform-origin: left center; transform: scaleX(0.7); white-space: nowrap;}
  #export-json, #import-json {
    display:block; resize: none; width: 29vw; height: 1.8vw;
    overflow-x:hidden; overflow-y:scroll;
    margin:3px 0 0 0; padding: 2px; border: 1px solid lightgrey;
    font-family: "Courier",monospace; font-size:9px;
    line-height: 11px; color:#404040; background-color: white;
    text-align: left; -webkit-touch-callout: text; -webkit-user-select: text;
    -khtml-user-select: text; -moz-user-select: text; -ms-user-select: text;
    user-select: text; opacity: 1;
  }

  .forcegraph-label { color: black;}

  a { cursor: pointer; pointer-events: auto; }
  .bar { fill: slategray; }
  .xaxis { font-size: 12px; }
  .yaxis { font-size: 16px; }

  #logo { margin: 3px; padding: 3px; position: fixed; z-index: 3; opacity: 0.6; bottom: 0; left: 2px; }
  #logo img { float:left; margin: 0; padding: 0; width: 3vw; height: 3vw; }

  .noselect { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
  .hidden { display: none; }
  .highlight { background: darkred; color: white; }
  .highlight span { color: darkred; }
  .disabled { opacity: 0.2; pointer-events: none; }
  .latex {}
  .pass { content: "PASS"; background: green; }
  .pass:after { content: "PASS"; }
  .fail { content: "FAIL"; background: darkred; }
  .fail:after { content: "FAIL"; }
</style>

<script nomodule>alert("You browser doesn't seem to support modules. Use a modern browser to run CliqueVM.");</script>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>

<script type="module">

import { Graphviz } from 'https://cdn.jsdelivr.net/npm/@hpcc-js/wasm@2.8.0/dist/graphviz.js';
import _3dForceGraph from 'https://cdn.jsdelivr.net/npm/3d-force-graph@1.70.20/+esm';
import { cm6 } from './modules/cm6.min.mjs';
import { TrigraphUI } from './modules/TrigraphUI.mjs';
import { ModelAPI } from './modules/ModelAPI.mjs';

// Global variables
const qm = new TrigraphUI();
let graphviz = null; // Graphviz DOT
let forcegraph = null; // Force graph 3D
let timerIdle = null; // Force graph idle timer
let timerPress = null; // Repeat command when user holds down a button
const timeoutIdle = 6000; // Timeout for force graph idle, in milliseconds
const timeoutPress = 200; // Repeat command timeout, in milliseconds
let scale = 0.5; // Zoom level
let graphw = 40; // Graph window width in percentage
const code = ['init','oper','eq','coord','detectors']; // Code segments
const cm6view = [null,null,null,null,null]; // CodeMirror views
const codesrc = [
  "return [{x:0,y:0,z:0},{x:0,y:0,z:0}];",
  "let s=[],t=[];\nfor( let p of c ) {\n  let [a,b]=this.clone([p,p]);\n  let i=this.shuffle(['x','y','z'])[0];\n  if (a[i]<3) a[i]++;\n  if (b[i]>-3) b[i]--;\n  s.push(a);\n  t.push(b);\n}\nreturn [s,t];",
  "return s1.x===s2.x && s1.y===s2.y && s1.z===s2.z;",
  "return s.x+','+s.y+','+s.z;",
  "return Array.from({length:7},(_,i)=>({x:i-3,y:0,z:0}));"
];

let prevcode = null; // Code when focusin

// Get URL parameters
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.href);
    return results === null ? false : decodeURIComponent(results[1].replace(/\+/g, '    '));
}

// The DOT renderer has finished all actions
function dotReady() {
  // Scale SVG based on current zoom level
  let svg = d3.select('#graph-dot > svg');
  if ( !svg.empty() ) {
    let s = scale;
    if ( d3.select('#snap').classed('selected') ||
          d3.select('#hits').classed('selected') ) {
      s = 1.2 * s;
    }
    const viewBox = svg.node().attributes.viewBox.value.split(' ').map(Number);
    svg.node().attributes.width.value = (4 * s * viewBox[2] / 3) + 'px';
    svg.node().attributes.height.value = (4 * s * viewBox[3] / 3) + 'px';

    // Zoom text
    d3.select('#zoom').text(Math.round(10*scale)/10);

    // Select clique
    d3.selectAll('.node').on('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      let sel = parseInt( d3.select(this).select('title').text() );
      render(sel);
    });
  }
}

function getTitle(t1,t2) {
  return '<div><span class="title1">'+t1+'</span><span class="title2">'+t2+'</span></div>';
}

// Reader graph
function render(sel=null) {
  try {
    let dot = null; // DOT language graph
    let svg = null; // SVG graph
    let data = null; // D3-force-3D graph data
    let title = ''; // Graph title
    let legend = null; // Legend

    // Use selected graph
    let graph = d3.select('.set-graph.selected').property('id');
    let view = d3.select('.set-'+graph+'.selected').property('id');

    switch( graph ) {

      case 'trace':
        switch( view ) {

          case 'trace-full':
            title = getTitle('MULTI-THREAD TRACE','Multiway evolution graph');
            legend = '#legend-operation,#legend-state,#legend-clique,#legend-location';
            dot = qm.dotMultiway( sel, 0 );
            break;

          case 'trace-clique':
            title = getTitle('MULTI-THREAD TRACE','Maximal cliques');
            legend = '#legend-clique,#legend-location';
            dot = qm.dotMultiway( sel, 1 );
            break;

          case 'trace-location':
            title = getTitle('MULTI-THREAD TRACE','Spacetime');
            legend = '#legend-location';
            dot = qm.dotMultiway( sel, 2 );
            break;
        }
        break;

      case 'snap':
        switch( view ) {

          case 'snap-state':
            title = getTitle('STATE SNAPSHOT','Spacelike foliation');
            legend = '#legend-state,#legend-location';
            dot = qm.dotHypersurface( sel, 0 );
            break;

          case 'snap-clique':
            title = getTitle('CLIQUE SNAPSHOT','Local clique graphs');
            legend = '#legend-clique,#legend-location';
            dot = qm.dotHypersurface( sel, 1 );
            break;

          case 'snap-location':
            title = getTitle('LOCATION SNAPSHOT','Branchial graph');
            legend = '#legend-location';
            dot = qm.dotHypersurface( sel, 2 );
            break;
        }
        break;

      case 'space':
        title = getTitle('SPATIAL 3D-PROJECTION','Locations with parent relations');
        legend = '#legend-density';
        data = qm.dataSpace();
        break;

      case 'hits':
        switch( view ) {
          case 'hits-count':
            title = getTitle('DETECTOR HITS','Count at current step');
            svg = qm.svgHits(0);
            break;
          case 'hits-sum':
            title = getTitle('DETECTOR HITS','Total cumulative count');
            svg = qm.svgHits(1);
            break;
        }
        break;
    }

    // Set title
    d3.select("#title").html(title);

    // Set legend
    d3.selectAll('.legend').classed('hidden',true);
    if ( legend ) {
      d3.selectAll(legend).classed('hidden',false);
    }

    // Render
    if ( data ) {
      d3.selectAll('.set-force').classed('hidden',false);
      d3.selectAll('.set-zoom').classed('hidden',true);
      d3.select("#graph-dot").classed('hidden', true);
      d3.select("#graph-force").classed('hidden', false);
      forcegraph.graphData(data);
      forcegraphResumeTimeout();
    } else {
      d3.selectAll('.set-force').classed('hidden',true);
      d3.selectAll('.set-zoom').classed('hidden',false);
      d3.select("#graph-dot").classed('hidden', false);
      d3.select("#graph-force").classed('hidden', true);
      if ( dot ) {
        let svg = graphviz.layout(dot,"svg","dot");
        document.getElementById("graph-dot").innerHTML = svg;
        dotReady();
      } else if ( svg ) {
        document.getElementById("graph-dot").innerHTML = "";
        d3.select("#graph-dot").append(() => svg.node());
        dotReady();
      } else {
        document.getElementById("graph-dot").innerHTML = "";
      }
    }

    // Display step
    d3.select("#step").text( qm.getStep() );

    // Display status
    qm.status().forEach( (x,i) => {
      d3.select('details#'+x.id+">p").html(x.text);
    });
    d3.select('details#d999>p').html(dot);

    // Typeset Math
    d3.selectAll('.latex').each( function(e) {
      renderMathInElement(this, {
        delimiters: [
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError : false
      });
    });
  }
  catch(ex) {
    if ( timerPress ) clearInterval( timerPress );
    console.log(ex);
    alert(ex);
  }
}

function loadCode() {
  code.forEach( (x,i) => {
    let e = d3.select("#"+x+".code");
    let v = localStorage.getItem(x) || codesrc[i];
    cm6view[i].dispatch( {changes: {from: 0, to: cm6view[i].state.doc.length, insert: v }} );
  });
}

function saveCode() {
  code.forEach( (x,i) => {
    let v = cm6view[i].state.doc.toString();
    localStorage.setItem(x,v);
  });
}

function getCode() {
  return code.map( (x,i) => {
    let v = cm6view[i].state.doc.toString();
    return '"use strict";\n' + v;
  });
}

function getCodeJson() {
  let o = {};
  code.forEach( (x,i) => {
    o[x] = cm6view[i].state.doc.toString();
  });
  return JSON.stringify(o);
}

function setCodeJson(json) {
  try {
    let o = JSON.parse(json);
    code.forEach( (x,i) => {
      if ( o[x] && typeof o[x] === 'string' ) {
        cm6view[i].dispatch( {changes: {from: 0, to: cm6view[i].state.doc.length, insert: o[x] }} );
      }
    });
  }
  catch(ex) {
    console.log(ex);
    alert(ex);
  }
  d3.selectAll('.code').dispatch("input");
  d3.select("#deploy").classed('highlight',true);
}

function reset() {

  // Validate code
  try {
    let code = getCode();
    let params = {
      api: new ModelAPI(),
      initf: new Function(code[0]),
      operf: new Function("c",code[1]),
      eqf: new Function("s1","s2",code[2]),
      coordf: new Function("s",code[3]),
      detectorsf: new Function(code[4])
    };

    qm.reset(params);

    d3.select("#reset").classed('disabled',true);
    d3.select("#incstep").classed('disabled',false);
    d3.select("#decstep").classed('disabled',true);

    render();
  }
  catch(ex) {
    d3.selectAll("#incstep,#decstep").classed('disabled',true);
    d3.select("#reset").classed('disabled',false);
    console.log(ex.stack);
    alert('There was an error in the MODEL:\n\n'+ex);
  }
}


// Pause rendering cycle
function forcegraphPause() {
  forcegraph.pauseAnimation();
}

// Resume rendering cycle
function forcegraphResume() {
  if ( !d3.select("#graph-force").classed('hidden') ) {
    forcegraph.resumeAnimation();
    if ( timerIdle ) { clearTimeout( timerIdle ); timerIdle = null; }
  }
}

// Resume rendering cycle
function forcegraphResumeTimeout() {
  if ( !d3.select("#graph-force").classed('hidden') ) {
    forcegraphResume();
    timerIdle = setTimeout( function() {
      forcegraphPause();
    }, timeoutIdle );
  }
}

// Set force
function forcegraphForce(force,friction) {
  forcegraph.d3Force("link").distance( force );
  forcegraph.d3Force("charge").strength( -10 * (force + 10) );
  forcegraph.d3VelocityDecay( friction / 100 );
  let d = forcegraph.graphData();
  forcegraph.graphData(d);
  forcegraphResumeTimeout();
}

// Resize force graph
function forcegraphResize() {
  let size = d3.select("#graph").node().getBoundingClientRect();
  forcegraph.width(size.width);
  forcegraph.height(size.height);
  forcegraphResumeTimeout();
}

// Zoom in
function zin() {
  scale *= 1.2;
  if ( scale >= 3 ) {
    d3.select('#zoom-in').classed('disabled',true);
    if ( timerPress ) timerPress = clearInterval(timerPress);
  }
  d3.select('#zoom-out').classed('disabled',false);
  render();
}

// Zoom out
function zout() {
  scale *= 0.8;
  if ( scale <= 0.05 ) {
    d3.select('#zoom-out').classed('disabled',true);
    if ( timerPress ) timerPress = clearInterval(timerPress);
  }
  d3.select('#zoom-in').classed('disabled',false);
  render();
}

// Increase step
function incstep() {
  try {
    let mode = 0;
    if ( d3.select("#observer-1").classed('selected') ) mode = 1;
    if ( d3.select("#observer-2").classed('selected') ) mode = 2;

    d3.select("#reset").classed('disabled',false);

    if ( qm.next(mode) ) {
      d3.select('#decstep').classed('disabled',false);
    } else {
      d3.select("#incstep").classed('disabled',true);
      if ( timerPress ) timerPress = clearInterval(timerPress);
    }
    render();

    // Scroll to bottom
    if ( d3.select('#trace').classed('selected') ) {
      const e = document.getElementById("graph-dot");
      e.scrollTop = e.scrollHeight;
    }
  }
  catch(ex) {
    if ( timerPress ) timerPress = clearInterval(timerPress);
    console.log(ex.stack);
    alert('There was an error in the MODEL:\n\n'+ex);
  }
}

// Decrease step
function decstep() {
  try {
    if ( !qm.prev() ) {
      d3.selectAll("#decstep,#reset").classed('disabled',true);
      if ( timerPress ) timerPress = clearInterval(timerPress);

      // Scroll to bottom
      if ( d3.select('#trace').classed('selected') ||
            d3.select('#snap').classed('selected') ) {
        const e = document.getElementById("graph-dot");
        e.scrollTop = e.scrollHeight;
      }
    }
    d3.select('#incstep').classed('disabled',false);
    render();
  }
  catch(ex) {
    if ( timerPress ) timerPress = clearInterval(timerPress);
    console.log(ex.stack);
    alert('There was an error in the MODEL:\n\n'+ex);
  }
}

// Load graphviz and reset
async function init() {

  let promises = [];
  promises.push( Graphviz.load() );

  let model = getUrlParameter('model');
  if ( model ) promises.push( d3.text(model) );

  const data = await Promise.allSettled( promises );

  // Graphviz
  if ( data[0].status === 'rejected' ) {
    alert('Loading Graphviz failed. Try reloading the page.:\n\n'+data[0].reason );
  } else {
    graphviz = data[0].value;

    // Model
    if ( model ) {
      if ( data[1].status === 'rejected' ) {
        alert('Loading JSON model failed:\n\n'+data[1].reason );
        loadCode();
      } else {
        setCodeJson(data[1].value);
      }
    } else {
      loadCode();
    }

    // Reset model
    reset();

    // View
    let view = getUrlParameter('view');
    if ( view ) {
      view.split(',').forEach( id => {
        let e = d3.select('#'+id);
        if ( !e.empty() ) e.dispatch('click');
      });
    }

    // Run
    let step = getUrlParameter('step');
    if ( step ) {
      let n = parseInt(step);
      if ( n && n > 0 ) {
        while (--n>0) incstep();
      }
    }
  }
}

document.addEventListener('DOMContentLoaded', function(e) {

  // Setup CodeMirror6
  code.forEach( (x,i) => {
    let s = cm6.createEditorState( "" );
    cm6view[i] = cm6.createEditorView( s, document.getElementById(x) );
  });

  // Setup force graph
  forcegraph = _3dForceGraph({ rendererConfig: { antialias: true, precision: "lowp" }})
    ( document.getElementById("graph-force") )
    .forceEngine('d3')
    .numDimensions( 3 )
    .showNavInfo( true )
    .enablePointerInteraction( true )
    .backgroundColor( 'white' )
    .warmupTicks(5)
    .cooldownTime( 5000 )
    .linkDirectionalArrowLength(0)
    .nodeVisibility( true )
    .linkVisibility( true )
    .nodeOpacity( 0.9 )
    .linkOpacity( 0.8 )
    .nodeRelSize( 8 )
    .nodeVal( n => 2  )
    .nodeColor( n => n.color )
    .nodeLabel( n => `<span class="forcegraph-label">${ n.id }</span>` )
    .linkWidth( l => 3 )
    .linkColor( l => l.color );
  forcegraph.controls().addEventListener( 'start', forcegraphResume );
  forcegraph.controls().addEventListener( 'end', forcegraphResumeTimeout );
  d3.select("#graph-dot").classed('hidden',true);
  forcegraphResize();

  forcegraph.d3Force("link").iterations( 15 );
  forcegraph.d3Force("center").strength( 1 );
  forcegraph.d3Force("charge").distanceMin( 20 );
  forcegraphForce(30,30);

  // Resize panel window width
  d3.select('#resizer').on('mousedown touchstart', function(e) {
    d3.select(document).on('mousemove touchmove', function(e) {
      let p = 100 * e.pageX / window.innerWidth;
      if ( p >= 20 && p < 80 ) {

        d3.select('#graph').style('flex-basis',p+'%');
        d3.select('#legend').style('right',(100-p)+'%');
        forcegraphResize();
      }
    });
    d3.select(document).on('mouseup mouseleave touchend touchcancel', function(e) {
      d3.select(document).on('mouseup mouseleave touchend mousemove touchmove touchcancel', null);
    }, {passive: false});
  }, {passive: false});

  // Window resize event, resume and update graph dimensions
  d3.select(window).on('resize', function(){
    forcegraphResize();
  });

  d3.selectAll('.code').on('focusin',function(e) {
    d3.selectAll(".js-test").classed('hidden',true);
    if ( d3.select("#deploy").classed('highlight') ) {
      prevcode = null;
    } else {
      d3.select("#deploy").classed('highlight',true);
      let id = d3.select(this).property('id');
      let ndx = code.indexOf(id);
      prevcode = cm6view[ndx].state.doc.toString();
    }
  }).on('focusout',function(e) {
    let id = d3.select(this).property('id');
    let ndx = code.indexOf(id);
    let currcode = cm6view[ndx].state.doc.toString();
    if ( prevcode === currcode ) {
      d3.select("#deploy").classed('highlight',false);
    }
  }).on('input change keydown', function(e) {
    this.style.height = 0;
    this.style.height = this.scrollHeight + "px";
  });

  // Toggle details, bug fix for hidden divs not resizing
  d3.selectAll('details').on('toggle', function(e) {
    let c = d3.select(this).select('.code');
    if ( !c.empty() ) c.dispatch('change');
  });

  // Reset
  d3.select('#reset').on('click', function(e) {
    reset();
  });

  // Zoom in/out
  d3.select('#zoom-in').on('mousedown', function(e) {
    timerPress = setInterval(zin, timeoutPress);
    zin();
  });

  d3.select('#zoom-out').on('mousedown', function(e) {
    timerPress = setInterval(zout, timeoutPress);
    zout();
  });

  // Inc/dec step
  d3.select('#incstep').on('mousedown', function(e) {
    timerPress = setInterval(incstep, timeoutPress);
    incstep();
  });

  d3.select('#decstep').on('mousedown', function(e) {
    timerPress = setInterval(decstep, timeoutPress);
    decstep();
  });

  // Release button
  d3.selectAll('#zoom-in,#zoom-out,#incstep,#decstep').on('mouseup mouseleave', function(e) {
    if ( timerPress ) timerPress = clearInterval(timerPress);
  });

  // Toggle model/code panel
  d3.selectAll('#model').on('click', function(e) {
    let on = !d3.select(this).classed('selected');
    d3.select(this).classed('selected', on);
    if (on) {
      d3.selectAll('#panel,#toolbar-panel').style('display','flex');
      d3.selectAll('.code').dispatch("input");
      d3.select('#resizer').style('display','block');
      d3.select('#graph').style('flex','0 0 ' + graphw + '%');
      d3.select('#legend').style('right',(100-graphw)+'%');
    } else {
      graphw = parseInt( d3.select('#graph').style('flex-basis') );
      d3.selectAll('#panel,#toolbar-panel').style('display','none');
      d3.select('#resizer').style('display','none');
      d3.select('#graph').style('flex','1');
      d3.select('#legend').style('right','0');
    }
    forcegraphResize();
  });

  // Graphs
  d3.selectAll('.set-graph').on('click', function(e) {
    d3.selectAll(".set-graph").classed('selected',false);
    d3.select(this).classed('selected', true);
    let graph = d3.select(this).property('id');
    d3.selectAll(".set-space,.set-trace,.set-snap,.set-hits").classed('hidden',true);
    d3.selectAll(".set-"+graph).classed('hidden',false);
    render();
  });

  // Views
  d3.selectAll('.set-space').on('click', function(e) {
    d3.selectAll(".set-space").classed('selected',false);
    d3.select(this).classed('selected', true);
    render();
  });

  d3.selectAll('.set-trace').on('click', function(e) {
    d3.selectAll(".set-trace").classed('selected',false);
    d3.select(this).classed('selected', true);
    render();
  });

  d3.selectAll('.set-snap').on('click', function(e) {
    d3.selectAll(".set-snap").classed('selected',false);
    d3.select(this).classed('selected', true);
    render();
  });

  d3.selectAll('.set-hits').on('click', function(e) {
    d3.selectAll(".set-hits").classed('selected',false);
    d3.select(this).classed('selected', true);
    render();
  });

  // Observers
  d3.selectAll('#observer-1,#observer-2').on('click', function(e) {
    let selected = d3.select(this).classed('selected');
    d3.selectAll("#observer-1,#observer-2").classed('selected',false);
    d3.select(this).classed('selected', !selected);
  });

  // Changed force
  d3.selectAll('#force-range,#friction-range').on('input change keyup', function() {
    let force = parseInt( d3.select("#force-range").property('value'), 10 );
    let friction = parseInt( d3.select("#friction-range").property('value'), 10 );
    forcegraphForce(force,friction);
  });

  // Run
  d3.select('#deploy').on('click', function(e) {
    saveCode();
    d3.selectAll(".js-test").classed('hidden',true);
    d3.selectAll(".js-debug").text('');
    d3.select(this).classed('highlight',false);
    reset();
  });

  // Test/debug
  d3.select('#debug').on('click', function(e) {
    let code = getCode();
    let api = new ModelAPI();
    let init;
    let status;
    let pass;

    // Test init
    status = "";
    pass = false;
    try {
      let f = new Function(code[0]);
      init = f.apply(api,[]);

      if ( !Array.isArray(init) ) {
				status = "ERROR: The returned value was not an array.";
			} else if ( init.length === 0 ) {
				status = "ERROR: The returned value was empty.";
			} else {
        pass = true;
      }

    }
    catch(ex) {
      console.log(ex.stack);
      status = '' + ex;
    }
    d3.select("#init-test")
      .classed('hidden',false)
      .classed('pass', pass)
      .classed('fail', !pass);
    d3.select("#init-debug").text(status);

    if ( !pass ) return;

    // Test oper
    status = "";
    pass = false;
    try {
      let f = new Function("c",code[1]);
      let o = f.apply(api,[init]);

      if ( !Array.isArray(o) ) {
        status = "ERROR: The returned value was not an array.";
      } else if ( o.length ) {
        if ( o.some( x => !Array.isArray(x) ) ) {
          status = "ERROR: One of the operations was not an array.";
        } else {
          pass = true;
        }
      } else {
        pass = true;
      }

    }
    catch(ex) {
      console.log(ex.stack);
      status = '' + ex;
    }
    d3.select("#oper-test")
      .classed('hidden',false)
      .classed('pass', pass)
      .classed('fail', !pass);
    d3.select("#oper-debug").text(status);

    // Test eq
    status = "";
    pass = false;
    try {
      let f = new Function("s1","s2",code[2]);
      let o = f.apply(api,[init[0],init[0]]);
      pass = true;
    }
    catch(ex) {
      console.log(ex.stack);
      status = '' + ex;
    }
    d3.select("#eq-test")
      .classed('hidden',false)
      .classed('pass', pass)
      .classed('fail', !pass);
    d3.select("#eq-debug").text(status);

    // Test coord
    status = "";
    pass = false;
    try {
      let f = new Function("s",code[3]);
      let o = f.apply(api,[init[0]]);
      pass = true;
    }
    catch(ex) {
      console.log(ex.stack);
      status = '' + ex;
    }
    d3.select("#coord-test")
      .classed('hidden',false)
      .classed('pass', pass)
      .classed('fail', !pass);
    d3.select("#coord-debug").text(status);

    // Test detectors
    status = "";
    pass = false;
    try {
      let f = new Function(code[4]);
      let o = f.apply(api);
      if ( !Array.isArray(o) ) {
				status = "ERROR: The returned value was not an array.";
			} else {
        pass = true;
      }
    }
    catch(ex) {
      console.log(ex.stack);
      status = '' + ex;
    }
    d3.select("#detectors-test")
      .classed('hidden',false)
      .classed('pass', pass)
      .classed('fail', !pass);
    d3.select("#detectors-debug").text(status);

  });

  // Export (copy)
  d3.select('#export').on('click', function(e) {
    let s = !d3.select(this).classed('selected');
    d3.select(this).classed('selected',s);
    if ( s ) {
      let json = getCodeJson();
      d3.select("#export-box").classed('hidden',false);
      d3.select("#export-json").property('value',json);
      let n = d3.select("#export-json").node();
      n.focus();
      n.select();
    } else {
      d3.select("#export-box").classed('hidden',true);
      d3.select("#export-json").property('value','');
    }
  });

  // Import (paste)
  d3.select('#import').on('click', function(e) {
    let s = !d3.select(this).classed('selected');
    d3.select(this).classed('selected',s);
    if ( s ) {
      d3.select("#import-box").classed('hidden',false);
      d3.select("#import-json").property('value','');
      let n = d3.select("#import-json").node();
      n.focus();
      n.select();
    } else {
      d3.select("#import-box").classed('hidden',true);
      let json = d3.select("#import-json").property('value');
      if ( json.length ) {
        setCodeJson( json );
      }
    }
  });


  // Open project's GitHub page
  d3.select('#github').on('click', function(e) {
    window.open('https://github.com/met4citizen/CliqueVM','_blank');
  });

  // Initialize
  init();

});

</script>
</head>
<body>
  <div id="outer">
    <div id="graph" class="noselect">
      <div id="graph-dot" class="hidden"></div>
      <div id="graph-force"></div>
    </div>
    <div id="resizer" class="noselect"></div>
    <div id="panel">

      <div id="text" spellcheck="false">
        <details>
          <summary class="noselect">INITIAL STATE<span id="init-test" class="js-test hidden"></span></summary>
          <p class="js">
            <span class="js-key">@return</span> {<span class="js-type">any[]</span>} Array of initial states.
          </p>
          <div id="init" class="code"></div>
          <p id="init-debug" class="js js-debug">
          </p>
        </details>
        <details open>
          <summary class="noselect">OPERATOR<span id="oper-test" class="js-test hidden"></span></summary>
          <p class="js">
            <span class="js-key">@param</span> {<span class="js-type">any[]</span>} <span class="js-param">c</span> Clique, array of input states<br>
            <span class="js-key">@return</span> {<span class="js-type">any[][]</span>} New operations with output states.
          </p>
          <div id="oper" class="code"></div>
          <p id="oper-debug" class="js js-debug">
          </p>
        </details>
        <details>
          <summary class="noselect">EQUIVALENCE<span id="eq-test" class="js-test hidden"></span></summary>
          <p class="js">
            <span class="js-key">@param</span> {<span class="js-type">any</span>} <span class="js-param">s1</span> State 1<br>
            <span class="js-key">@param</span> {<span class="js-type">any</span>} <span class="js-param">s2</span> State 2<br>
            <span class="js-key">@return</span> {<span class="js-type">boolean</span>} True if the states are equivalent.
          </p>
          <div id="eq" class="code"></div>
          <p id="eq-debug" class="js js-debug">
          </p>
        </details>
        <details>
          <summary class="noselect">COORDINATE<span id="coord-test" class="js-test hidden"></span></summary>
          <p class="js">
            <span class="js-key">@param</span> {<span class="js-type">any</span>} <span class="js-param">s</span> State<br>
            <span class="js-key">@return</span> {<span class="js-type">string</span>} Spatial coordinate.
          </p>
          <div id="coord" class="code"></div>
          <p id="coord-debug" class="js js-debug">
          </p>
        </details>
        <details>
          <summary class="noselect">DETECTORS<span id="detectors-test" class="js-test hidden"></span></summary>
          <p class="js">
            <span class="js-key">@return</span> {<span class="js-type">any[]</span>} Array of detector states.
          </p>
          <div id="detectors" class="code"></div>
          <p id="detectors-debug" class="js js-debug">
          </p>
        </details>
        <details id="d0" class="latex">
          <summary class="noselect">INFO</summary>
          <p></p>
        </details>
        <details id="d999">
          <summary class="noselect">DOT</summary>
          <p></p>
        </details>
      </div>
    </div>

    <div id="toolbar-panel" class="noselect">
      <span id="deploy" class="unit unit-action">
        <span class="subtitle">Deploy</span>
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2"  />
          <path d="M16 12L10 16.3301V7.66987L16 12Z" fill="currentColor" />
        </svg>
      </span>
      <span id="debug" class="unit unit-action">
        <span class="subtitle">Debug</span>
        <svg viewBox="-2 -2 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 11C10 10.4477 10.4477 10 11 10H13C13.5523 10 14 10.4477 14 11C14 11.5523 13.5523 12 13 12H11C10.4477 12 10 11.5523 10 11Z" fill="currentColor" />
          <path d="M11 14C10.4477 14 10 14.4477 10 15C10 15.5523 10.4477 16 11 16H13C13.5523 16 14 15.5523 14 15C14 14.4477 13.5523 14 13 14H11Z" fill="currentColor" />
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9.09447 4.74918C8.41606 4.03243 8 3.0648 8 2H10C10 3.10457 10.8954 4 12 4C13.1046 4 14 3.10457 14 2H16C16 3.0648 15.5839 4.03243 14.9055 4.74918C16.1782 5.45491 17.1673 6.6099 17.6586 8H19C19.5523 8 20 8.44772 20 9C20 9.55229 19.5523 10 19 10H18V12H19C19.5523 12 20 12.4477 20 13C20 13.5523 19.5523 14 19 14H18V16H19C19.5523 16 20 16.4477 20 17C20 17.5523 19.5523 18 19 18H17.6586C16.8349 20.3304 14.6124 22 12 22C9.38756 22 7.16508 20.3304 6.34141 18H5C4.44772 18 4 17.5523 4 17C4 16.4477 4.44772 16 5 16H6V14H5C4.44772 14 4 13.5523 4 13C4 12.4477 4.44772 12 5 12H6V10H5C4.44772 10 4 9.55229 4 9C4 8.44772 4.44772 8 5 8H6.34141C6.83274 6.6099 7.82181 5.45491 9.09447 4.74918ZM8 16V10C8 7.79086 9.79086 6 12 6C14.2091 6 16 7.79086 16 10V16C16 18.2091 14.2091 20 12 20C9.79086 20 8 18.2091 8 16Z" fill="currentColor" />
        </svg>
      </span>

      <span id="title-model"></span>

      <span id="export" class="unit unit-action">
        <span class="subtitle">Export</span>
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill="none" stroke="currentColor" stroke-width="1.6" d="M9 10 9 6 18 6 18 18 9 18 9 14" />
          <path fill="none" stroke="currentColor" stroke-width="1.4" d="M3 12 14.5 12M11.5 9 14.5 12 11.5 15" />
        </svg>
      </span>
      <span id="import" class="unit unit-action">
        <span class="subtitle">Import</span>
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill="none" stroke="currentColor" stroke-width="1.6" d="M9 10 9 6 18 6 18 18 9 18 9 14" />
          <path fill="none" stroke="currentColor" stroke-width="1.4" d="M14 12 4 12M6 9 3 12 6 15" />
        </svg>
      </span>

      <span id="github" class="unit unit-action" title="GitHub">
        <span class="subtitle">GitHub</span>
        <svg viewBox="-1 -1 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="currentColor"/>
        </svg>
      </span>

    </div>

  </div>

  <div id="toolbar" class="noselect">

    <span id="trace" class="unit unit-action set-graph selected" title="Multithread trace">
      <span class="subtitle">Trace</span>
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <marker id="triangle" viewBox="0 0 10 10" refX="1" refY="5" markerUnits="strokeWidth" markerWidth="3" markerHeight="3" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="currentColor" fill-opacity="0.5" />
          </marker>
        </defs>
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" marker-end="url(#triangle)" x1="10" y1="6" x2="7" y2="10" />
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" marker-end="url(#triangle)" x1="10" y1="6" x2="10" y2="10" />
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" marker-end="url(#triangle)" x1="10" y1="6" x2="13" y2="10" />
        <ellipse fill="currentColor" stroke="currentColor" stroke-width="1" cx="10" cy="6" rx="1.8" ry="1.8" />
        <ellipse fill="none" stroke="currentColor" stroke-width="0.9" cx="5" cy="14" rx="1.8" ry="1.8" />
        <ellipse fill="none" stroke="currentColor" stroke-width="0.9" cx="10" cy="14" rx="1.8" ry="1.8" />
        <ellipse fill="none" stroke="currentColor" stroke-width="0.9" cx="15" cy="14" rx="1.8" ry="1.8" />
      </svg>
    </span>
    <span id="snap" class="unit unit-action set-graph" title="Snap">
      <span class="subtitle">Snap</span>
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" x1="9.5" y1="8" x2="6.5" y2="12" />
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" x1="10.5" y1="8" x2="12.5" y2="12" />
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" x1="8" y1="13" x2="12" y2="13" />
        <ellipse fill="none" stroke="currentColor" stroke-width="1" cx="10" cy="7" rx="1.8" ry="1.8" />
        <ellipse fill="none" stroke="currentColor" stroke-width="1" cx="6" cy="13" rx="1.8" ry="1.8" />
        <ellipse fill="none" stroke="currentColor" stroke-width="1" cx="14" cy="13" rx="1.8" ry="1.8" />
      </svg>
    </span>
    <span id="space" class="unit unit-action set-graph" title="Spatial projection">
      <span class="subtitle">Space</span>
      <svg viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" x1="5" y1="7" x2="5" y2="14" />
        <line stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" x1="5" y1="7" x2="10" y2="5" />
        <line stroke="currentColor" stroke-width="1.1" stroke-opacity="0.5" x1="5" y1="7" x2="10" y2="9" />
        <line stroke="currentColor" stroke-width="1" stroke-opacity="0.5" x1="15" y1="7" x2="15" y2="14" />
        <line stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" x1="15" y1="7" x2="10" y2="5" />
        <line stroke="currentColor" stroke-width="1.1" stroke-opacity="0.5" x1="15" y1="7" x2="10" y2="9" />
        <line stroke="currentColor" stroke-width="1.1" stroke-opacity="0.5" x1="10" y1="16" x2="5" y2="14" />
        <line stroke="currentColor" stroke-width="1.2" stroke-opacity="0.5" x1="10" y1="16" x2="10" y2="9" />
        <line stroke="currentColor" stroke-width="1.1" stroke-opacity="0.5" x1="10" y1="16" x2="15" y2="14" />
        <ellipse fill="currentColor" stroke="none" cx="5" cy="7" rx="1.4" ry="1.4" />
        <ellipse fill="currentColor" stroke="none" cx="5" cy="14" rx="1.4" ry="1.4" />
        <ellipse fill="currentColor" stroke="none" cx="10" cy="5" rx="1.35" ry="1.35" />
        <ellipse fill="currentColor" stroke="none" cx="10" cy="9" rx="1.55" ry="1.55" />
        <ellipse fill="currentColor" stroke="none" cx="10" cy="16" rx="1.55" ry="1.55" />
        <ellipse fill="currentColor" stroke="none" cx="15" cy="7" rx="1.4" ry="1.4" />
        <ellipse fill="currentColor" stroke="none" cx="15" cy="14" rx="1.4" ry="1.4" />
      </svg>
    </span>
    <span id="hits" class="unit unit-action set-graph" title="Detector counters">
      <span class="subtitle">Hits</span>
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path stroke="currentColor" stroke-width="2" d="M7 10V14M10 5V14M13 7V14"/>
        <path stroke="currentColor" stroke-width="1" stroke-opacity="0.5" d="M4 4V15H16"/>
      </svg>
    </span>

    <span class="unit unit-text set-trace">
      <span class="subtitle">&gt;</span>
    </span>
    <span id="trace-full" class="unit unit-action set-trace selected" title="All details">
      <span class="subtitle">Details</span>
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <ellipse fill="currentColor" stroke="currentColor" stroke-width="1.2" cx="7" cy="7" rx="1.5" ry="1.5"/>
        <ellipse fill="none" stroke="currentColor" stroke-width="1.2" cx="13" cy="7" rx="1.5" ry="1.5"/>
        <polygon fill="currentColor" fill-opacity="0.5" stroke="currentColor" stroke-width="1" points="5,15 5,11 9,11 9,15 5,15"/>
        <polygon fill="none" stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" points="11,15 11,11 15,11 15,15 11,15"/>
      </svg>
    </span>
    <span id="trace-clique" class="unit unit-action set-trace" title="Cliques">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="currentColor" fill-opacity="0.5" stroke="currentColor" stroke-width="1" points="5,12 5,8 9,8 9,12 5,12"/>
        <polygon fill="none" stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" points="11,12 11,8 15,8 15,12 11,12"/>
      </svg>
    </span>
    <span id="trace-location" class="unit unit-action set-trace" title="Only locations">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="none" stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" points="8,12 8,8 12,8 12,12 8,12"/>
      </svg>
    </span>

    <span class="unit unit-text set-snap hidden">
      <span class="subtitle">&gt;</span>
    </span>
    <span id="snap-state" class="unit unit-action set-snap selected hidden" title="States">
      <span class="subtitle">Level</span>
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <ellipse fill="none" stroke="currentColor" stroke-width="1.2" cx="7" cy="10" rx="1.5" ry="1.5"/>
        <polygon fill="none" stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" points="11,12 11,8 15,8 15,12 11,12"/>
      </svg>
    </span>
    <span id="snap-clique" class="unit unit-action set-snap hidden" title="Cliques">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="currentColor" fill-opacity="0.5" stroke="currentColor" stroke-width="1" points="5,12 5,8 9,8 9,12 5,12"/>
        <polygon fill="none" stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" points="11,12 11,8 15,8 15,12 11,12"/>
      </svg>
    </span>
    <span id="snap-location" class="unit unit-action set-snap hidden" title="Locations">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="none" stroke="currentColor" stroke-width="0.9" stroke-opacity="0.5" points="8,12 8,8 12,8 12,12 8,12"/>
      </svg>
    </span>

    <span class="unit unit-text set-space hidden">
      <span class="subtitle">&gt;</span>
    </span>
    <span id="space-3d" class="unit unit-action set-space selected hidden">
      <span class="subtitle">Dim</span>
      3D
    </span>
    <span class="unit unit-text set-space hidden"></span>
    <span class="unit unit-text set-space hidden"></span>

    <span class="unit unit-text set-hits hidden">
      <span class="subtitle">&gt;</span>
    </span>
    <span id="hits-count" class="unit unit-action set-hits selected hidden" title="Count">
      <span class="subtitle">Step</span>
      <svg viewBox="0.2 0 20.2 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="currentColor" points="6.5,7 14.5,7 14.5,8.5 6.5,8.5 6.5,7"/>
        <polygon fill="currentColor" points="6.3,11 14.3,11 14.3,12.5 6.3,12.5 6.3,11"/>
        <polygon fill="currentColor" points="9,4 10,4 9,15.5 8,15.5 9,4"/>
        <polygon fill="currentColor" points="12,4 13,4 12,15.5 11,15.5 12,4"/>
      </svg>
    </span>
    <span id="hits-sum" class="unit unit-action set-hits hidden" title="Cumulative sum">
      <span class="subtitle">Total</span>
      <svg viewBox="-4 -4 26 26" xmlns="http://www.w3.org/2000/svg" >
        <path d="M14 6 14 3 3 3 7.5 9 3 15 14 15 14 12 13 12 13 13 7 13 10 9 7 5 13 5 13 6 Z" fill="currentColor" />
      </svg>
    </span>
    <span class="unit unit-text set-hits hidden" title=""></span>

    <span id="title" class="latex"></span>

    <span id="zoom-out" class="unit unit-action set-zoom" title="Zoom out">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M15.3431 15.2426C17.6863 12.8995 17.6863 9.1005 15.3431 6.75736C13 4.41421 9.20101 4.41421 6.85786 6.75736C4.51472 9.1005 4.51472 12.8995 6.85786 15.2426C9.20101 17.5858 13 17.5858 15.3431 15.2426ZM16.7574 5.34315C19.6425 8.22833 19.8633 12.769 17.4195 15.9075C17.4348 15.921 17.4498 15.9351 17.4645 15.9497L21.7071 20.1924C22.0976 20.5829 22.0976 21.2161 21.7071 21.6066C21.3166 21.9971 20.6834 21.9971 20.2929 21.6066L16.0503 17.364C16.0356 17.3493 16.0215 17.3343 16.008 17.319C12.8695 19.7628 8.32883 19.542 5.44365 16.6569C2.31946 13.5327 2.31946 8.46734 5.44365 5.34315C8.56785 2.21895 13.6332 2.21895 16.7574 5.34315ZM7.10052 10V12H15.1005V10L7.10052 10Z" fill="currentColor" />
      </svg>
    </span>
    <span class="unit unit-text set-zoom">
      <span class="subtitle">Zoom</span>
      <span id="zoom">1.2</span>
    </span>
    <span id="zoom-in" class="unit unit-action set-zoom" title="Zoom in">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M15.3431 15.2426C17.6863 12.8995 17.6863 9.1005 15.3431 6.75736C13 4.41421 9.20101 4.41421 6.85786 6.75736C4.51472 9.1005 4.51472 12.8995 6.85786 15.2426C9.20101 17.5858 13 17.5858 15.3431 15.2426ZM16.7574 5.34315C19.6425 8.22833 19.8633 12.769 17.4195 15.9075C17.4348 15.921 17.4498 15.9351 17.4645 15.9497L21.7071 20.1924C22.0976 20.5829 22.0976 21.2161 21.7071 21.6066C21.3166 21.9971 20.6834 21.9971 20.2929 21.6066L16.0503 17.364C16.0356 17.3493 16.0215 17.3343 16.008 17.319C12.8695 19.7628 8.32883 19.542 5.44365 16.6569C2.31946 13.5327 2.31946 8.46734 5.44365 5.34315C8.56785 2.21895 13.6332 2.21895 16.7574 5.34315ZM10.1005 7H12.1005V10H15.1005V12H12.1005V15H10.1005V12H7.10052V10H10.1005V7Z" fill="currentColor" />
      </svg>
    </span>

    <span class="unit unit-force set-force hidden" title="Zoom out">
      <span class="subtitle">Force</span>
      <input id="force-range" type="range" value="30" min="0" max="100">
    </span>
    <span class="unit unit-force set-force hidden" title="Zoom in">
      <span class="subtitle">Friction</span>
      <input id="friction-range" type="range" value="30" min="0" max="100">
    </span>

    <span class="unit unit-text"></span>

    <span id="reset" class="unit unit-action disabled" title="Reset">
      <span class="subtitle">Reset</span>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M5.33929 4.46777H7.33929V7.02487C8.52931 6.08978 10.0299 5.53207 11.6607 5.53207C15.5267 5.53207 18.6607 8.66608 18.6607 12.5321C18.6607 16.3981 15.5267 19.5321 11.6607 19.5321C9.51025 19.5321 7.58625 18.5623 6.30219 17.0363L7.92151 15.8515C8.83741 16.8825 10.1732 17.5321 11.6607 17.5321C14.4222 17.5321 16.6607 15.2935 16.6607 12.5321C16.6607 9.77065 14.4222 7.53207 11.6607 7.53207C10.5739 7.53207 9.56805 7.87884 8.74779 8.46777L11.3393 8.46777V10.4678H5.33929V4.46777Z" fill="currentColor" />
      </svg>
    </span>

    <span id="decstep" class="unit unit-action disabled" title="Previous step">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 17L10 12L18 7V17Z" fill="currentColor" />
        <path d="M6 7H9V17H6V7Z" fill="currentColor" />
      </svg>
    </span>
    <span class="unit unit-text">
      <span class="subtitle">Step</span>
      <span id="step" style="width:3vw;heigth:3vw;">1</span>
    </span>
    <span id="incstep" class="unit unit-action" title="Next step">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 17L14 12L6 7V17Z" fill="currentColor" />
        <path d="M18 7H15V12V17H18V7Z" fill="currentColor" />
      </svg>
    </span>

    <span class="unit unit-text"></span>

    <span id="observer-1" class="unit unit-action" title="QM observer, random">
      <svg viewBox="-6 -6 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14.9451 7.05518C14.9451 5.95061 15.8405 5.05518 16.9451 5.05518C18.0496 5.05518 18.9451 5.95061 18.9451 7.05518C18.9451 8.15975 18.0496 9.05518 16.9451 9.05518C15.8405 9.05518 14.9451 8.15975 14.9451 7.05518Z" fill="currentColor" />
        <path d="M16.9451 14.8921C15.8405 14.8921 14.9451 15.7875 14.9451 16.8921C14.9451 17.9967 15.8405 18.8921 16.9451 18.8921C18.0496 18.8921 18.9451 17.9967 18.9451 16.8921C18.9451 15.7875 18.0496 14.8921 16.9451 14.8921Z" fill="currentColor" />
        <path d="M5.05518 16.8921C5.05518 15.7875 5.95061 14.8921 7.05518 14.8921C8.15975 14.8921 9.05518 15.7875 9.05518 16.8921C9.05518 17.9967 8.15975 18.8921 7.05518 18.8921C5.95061 18.8921 5.05518 17.9967 5.05518 16.8921Z" fill="currentColor" />
        <path d="M7.05518 5.05518C5.95061 5.05518 5.05518 5.95061 5.05518 7.05518C5.05518 8.15975 5.95061 9.05518 7.05518 9.05518C8.15975 9.05518 9.05518 8.15975 9.05518 7.05518C9.05518 5.95061 8.15975 5.05518 7.05518 5.05518Z" fill="currentColor" />
        <path d="M10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12Z" fill="currentColor" />
        <path fill-rule="evenodd" clip-rule="evenodd" d="M1 4C1 2.34315 2.34315 1 4 1H20C21.6569 1 23 2.34315 23 4V20C23 21.6569 21.6569 23 20 23H4C2.34315 23 1 21.6569 1 20V4ZM4 3H20C20.5523 3 21 3.44772 21 4V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V4C3 3.44772 3.44772 3 4 3Z" fill="currentColor" />
      </svg>
    </span>
    <span class="unit unit-zero">
      <span class="subtitle">Observation/QM</span>
    </span>
    <span id="observer-2" class="unit unit-action" title="QM observer, max">
      <span style="display:block; transform: scale(0.8,1.1);">MAX</span>
    </span>

    <span class="unit unit-text"></span>
    <span class="unit unit-text"></span>

    <span id="model" class="unit unit-action" title="Edit model">
      <span class="subtitle">Model</span>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13.325 3.05011L8.66741 20.4323L10.5993 20.9499L15.2568 3.56775L13.325 3.05011Z" fill="currentColor" />
        <path d="M7.61197 18.3608L8.97136 16.9124L8.97086 16.8933L3.87657 12.1121L8.66699 7.00798L7.20868 5.63928L1.04956 12.2017L7.61197 18.3608Z" fill="currentColor" />
        <path d="M16.388 18.3608L15.0286 16.9124L15.0291 16.8933L20.1234 12.1121L15.333 7.00798L16.7913 5.63928L22.9504 12.2017L16.388 18.3608Z" fill="currentColor" />
      </svg>
    </span>
  </div>

  <div id="export-box" class="hidden">
    <span>Copy the model below by pressing CMD+C or Ctrl+C:</span>
    <textarea id="export-json" spellcheck="false" wrap="on">
    </textarea>
  </div>

  <div id="import-box" class="hidden">
    <span>Paste the model below by pressing CMD+V or Ctrl+V:</span>
    <textarea id="import-json" spellcheck="false" wrap="on">
    </textarea>
  </div>

  <div id="legend" class="noselect">
    <div id="legend-operation" class="legend hidden">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <ellipse fill="black" stroke="black" cx="10" cy="10" rx="5" ry="5" />
      </svg>
      Operation
    </div>
    <div id="legend-state" class="legend hidden">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <ellipse fill="white" stroke="black" cx="10" cy="10" rx="5" ry="5"></ellipse>
      </svg>
      State
    </div>
    <div id="legend-location" class="legend hidden">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="transparent" stroke="grey" points="1,1 1,19, 19,19, 19,1" />
      </svg>
      Location
    </div>
    <div id="legend-clique" class="legend hidden">
      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon fill="#e34a33" stroke="black" points="3,17 3,3 17,3 17,17 3,17" />
      </svg>
      Clique
    </div>
    <div id="legend-density" class="legend hidden">
      <svg viewBox="0 0 100 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="grad" x1="0" x2="1" y1="0" y2="0">
            <stop offset="0%" stop-color="#20FFFF" />
            <stop offset="50%" stop-color="#FFFF00" />
            <stop offset="100%" stop-color="#FF2020" />
          </linearGradient>
        </defs>
        <ellipse cx="10" cy="10" rx="10" ry="10" fill="lightgray" />
        <rect x="25" y="0" width="75" height="20" fill="url(#grad)" />
      </svg>
      <br>Thread count
    </div>
  </div>

  <div id="logo" class="noselect">
    <img src="data:image/png;base64,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" alt="" />
  </div>

</body>
</html>
